<!doctype html>
<html lang="pt-PT">

<head>
  <link
    href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&family=Luckiest+Guy&family=Sriracha&display=swap"
    rel="stylesheet">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa CEsA</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg: #F5E9D0;
      --accent: #E47D29;
      --card: #fff;
      --muted: #6b6b6b;
      --glass: rgba(255, 255, 255, 0.88);
      --panel-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);

      --font-body: 'Heebo', sans-serif;
      --font-title: 'Luckiest Guy', cursive;
      --font-subtitle: 'Sriracha', cursive;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: var(--font-body);
      background: var(--bg);
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    /* Search (top-right) */
    .search-box {
      position: absolute;
      top: 12px;
      right: 20px;
      z-index: 1400;
    }

    .search-box input {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #ccc;
      width: 378px;
      font-size: 14px;
      background: #fff;
      font-family: var(--font-body);
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 6px rgba(228, 125, 41, 0.18);
    }

    #searchResults {
      position: absolute;
      top: 46px;
      right: 0;
      z-index: 1500;
      width: 376px;
      max-height: 300px;
      overflow-y: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      display: none;
      padding: 10px;
      font-family: var(--font-body);
    }

    #searchResults li {
      list-style: none;
      padding: 10px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: var(--font-body);
    }

    #searchResults li:hover {
      background: #fbefe0;
    }

    .result-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .result-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 6px;
      background-color: #eee;
    }

    .result-item .m-title {
      font-weight: bold;
      color: var(--accent);
      font-family: var(--font-title);
      font-weight: 400;
      letter-spacing: 0.1em;
    }

    .result-item .m-cat {
      font-size: 12px;
      color: var(--muted);
      font-family: var(--font-subtitle);
    }

    /* Bot√£o Digitais (canto inferior esquerdo) */
    #digitalBtn {
      position: fixed;
      left: 15px;
      bottom: 100px;
      z-index: 1500;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #0076C0;
      color: #fff;
      font-size: 24px;
      border: none;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
      transition: transform 0.2s ease, background 0.2s;
      font-family: var(--font-body);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #digitalBtn:hover {
      background: #0076C0;
    }

    #digitalPanel {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 360px;
      max-height: 70vh;
      background: var(--glass);
      backdrop-filter: blur(6px);
      border-radius: 12px;
      box-shadow: var(--panel-shadow);
      border: 1px solid rgba(0, 0, 0, 0.08);
      display: none;
      flex-direction: column;
      z-index: 2000;
      overflow: hidden;
      animation: fadeIn 0.2s ease;
      font-family: var(--font-body);
    }

    #digitalPanel.open {
      display: flex;
    }

    #digitalPanel h3 {
      margin: 0;
      padding: 12px 16px;
      background: #0076C0;
      color: white;
      font-size: 16px;
      text-align: center;
      font-family: var(--font-subtitle);
    }

    #digitalList {
      list-style: none;
      margin: 0;
      padding: 10px;
      overflow-y: auto;
      flex: 1;
    }

    #digitalList li {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      background: white;
      border-radius: 8px;
      margin-bottom: 6px;
      font-family: var(--font-body);
    }

    #digitalList li:hover {
      background: #fbefe0;
    }

    #digitalList img {
      width: 44px;
      height: 44px;
      border-radius: 6px;
      object-fit: cover;
      background: #eee;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* SIDE PANEL com scroll total */
    .side-panel {
      position: fixed;
      right: 18px;
      top: 56px;
      width: 35%;
      max-width: 400px;
      min-width: 280px;
      height: calc(100vh - 96px);
      background: var(--glass);
      border-radius: 12px;
      box-shadow: var(--panel-shadow);
      z-index: 2000;
      transform: translateX(420px);
      transition: transform 260ms ease;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(0, 0, 0, 0.04);
      backdrop-filter: blur(4px);
      font-family: var(--font-body);
    }

    .side-panel.open {
      transform: translateX(0);
    }

    @media(max-width:900px) {
      .side-panel {
        width: 90%;
        right: 6px;
        transform: translateX(110%);
      }
    }

    /* Bot√£o fechar colado no topo do scroll, por cima da barra */
    .panel-close {
      position: sticky;
      top: 4px;
      right: -6px;
      margin-left: auto;
      margin-right: 4px;
      background: rgba(255, 255, 255, 0.95);
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
      z-index: 10;
      font-size: 14px;
      line-height: 1;
    }

    .panel-header {
      position: relative;
      padding: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.98));
    }

    .panel-header img {
      width: 300px;
      height: 200px;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.12);
      border: 4px solid rgba(255, 255, 255, 0.85);
      background: #eee;
    }

    .panel-name {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent);
      text-align: center;
      margin-top: 6px;
      font-family: var(--font-title);
      font-weight: 400;
      letter-spacing: 0.1em;
    }

    .panel-cat {
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      font-family: var(--font-subtitle);
    }

    /* Etiquetas de subcategoria no side panel */
    .panel-subcats {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
      margin: 4px 12px 4px 12px;
    }

    .subcat-tag {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: #fff6f0;
      color: var(--accent);
      border: 1px solid rgba(228, 125, 41, 0.2);
      font-family: var(--font-body);
      white-space: nowrap;
    }

    .media-row {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-top: 6px;
    }

    .media-row a {
      display: inline-flex;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      border: 1px solid rgba(0, 0, 0, 0.06);
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      font-size: 16px;
    }

    .panel-about {
      margin: 0 30px;
    }

    .section-title {
      color: var(--accent);
      font-weight: 700;
      padding-left: 15%;
      margin: 5px 0px;
      font-size: 13px;
      font-family: var(--font-subtitle);
      letter-spacing: 0.1em;
    }

    .section-about-title {
      color: var(--accent);
      font-weight: 700;
      margin: 5px 0;
      font-size: 13px;
      font-family: var(--font-subtitle);
      letter-spacing: 0.1em;
    }

    .about {
      font-size: 14px;
      color: #333;
      margin-bottom: 12px;
      white-space: pre-wrap;
      font-family: var(--font-body);
    }

    .panel-body {
      padding: 12px 16px;
      margin: 0 12px 12px 12px;
      flex: 1;
      overflow: visible;
    }

    .info-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 4px 4px;
    }

    .info-icon {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex: 0 0 34px;
    }

    .info-text {
      font-size: 14px;
      color: #333;
      word-break: break-word;
      font-family: var(--font-body);
    }

    .static-activities {
      margin-top: 12px;
      padding: 10px;
      background: #fff6f0;
      border-radius: 8px;
      border: 1px solid rgba(228, 125, 41, 0.06);
      color: var(--muted);
      font-size: 13px;
      font-family: var(--font-body);
    }

    /* Panel base de filtros (compartilhado) */
    .filter-panel {
      position: absolute;
      bottom: 16px;
      z-index: 1300;
      border-radius: 5px;
      padding: 10px;
      background: var(--card);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      display: none;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      max-width: 198px;
      font-family: var(--font-body);
    }

    #filterPanel {
      left: 90px;
    }

    #filterCategories {
      left: 90px;
    }

    .filter-panel.open {
      display: flex;
    }

    .filter-item {
      border-radius: 25px;
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      color: var(--accent);
      font-size: 13px;
      font-family: var(--font-subtitle);
    }

    .filter-item.active {
      background: var(--card);
      color: #fff;
    }

    .filter-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      width: 100%;
      margin-top: 4px;
    }

    .toggle-all {
      padding: 6px 10px;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      font-family: var(--font-body);
    }

    #toggleFilterBtn {
      position: absolute;
      bottom: 28px;
      left: 16px;
      z-index: 1400;
      width: 58px;
      height: 58px;
      border-radius: 16px;
      background: #fff;
      color: #0076C0;
      font-size: 28px;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, background 0.2s;
    }

    /* Menu de escolha de tipo de filtro */
    #filterMode {
      position: absolute;
      bottom: 46px;
      left: 86px;
      z-index: 1450;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 6px;
      min-width: 220px;
    }

    #filterMode.open {
      display: flex;
    }

    .mode-btn {
      border: none;
      border-radius: 8px;
      padding: 8px 10px;
      background: #f5f9ff;
      color: #0076C0;
      font-size: 13px;
      font-weight: 600;
      font-family: var(--font-body);
      cursor: pointer;
      text-align: left;
    }

    .mode-btn:hover {
      background: #e4f0ff;
    }

    /* leaflet z-index */
    .leaflet-container {
      z-index: 0;
      font-family: var(--font-body);
    }

    .leaflet-control-zoom-in,
    .leaflet-control-zoom-out {
      background: transparent !important;
      color: transparent !important;
      width: 60px !important;
      height: 60px !important;
      border: none !important;
      box-shadow: none !important;
      border-radius: 0 !important;
      padding: 0 !important;
      display: flex !important;
      align-items: center;
      justify-content: center;
    }

    .leaflet-control-zoom-in::before {
      content: "";
      width: 58px;
      height: 58px;
      background-image: url("icons_filter/zoomMaxIcon.svg");
    }

    .leaflet-control-zoom-out::before {
      content: "";
      width: 58px;
      height: 58px;
      background-image: url("icons_filter/zoomMinIcon.svg");
    }

    .leaflet-control-zoom-in span,
    .leaflet-control-zoom-out span {
      color: transparent !important;
      font-size: 0 !important;
    }

    /* Preview 3 digitais */
    #digitalPreview3 {
      position: fixed;
      left: 50%;
      top: calc(95% - 110px);
      transform: translateX(-50%);
      z-index: 1490;
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 8px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      max-width: 520px;
      overflow: hidden;
      transition: opacity 160ms.ease, transform 160ms.ease;
      pointer-events: auto;
    }

    .digital3-tile {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      background: #fff;
      border-radius: 8px;
      padding: 6px;
      min-width: 100px;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.04);
      text-align: center;
    }

    .digital3-tile img {
      width: 56px;
      height: 56px;
      object-fit: cover;
      border-radius: 8px;
      background: #eee;
    }

    .digital3-tile .d3-name {
      font-size: 12px;
      color: var(--accent);
      font-weight: 700;
      font-family: var(--font-subtitle);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 90px;
    }

    @media (max-width: 480px) {
      #digitalPreview3 {
        top: calc(90% - 140px);
        gap: 6px;
        padding: 6px;
        max-width: 92%;
      }

      .digital3-tile {
        min-width: 80px;
      }

      .digital3-tile .d3-name {
        font-size: 11px;
        width: 72px;
      }
    }
  </style>
</head>

<body>

  <div class="search-box">
    <input id="searchInput" type="text" placeholder="üîç Pesquisar organiza√ß√µes..." />
    <ul id="searchResults"></ul>
  </div>

  <!-- Bot√£o Digitais -->
  <button id="digitalBtn" title="Ver Associa√ß√µes Digitais">
    <img src="icons_filter/iconDigital.svg" alt="Associa√ß√µes Digitais" class="icon-svg">
  </button>

  <!-- Painel com lista de Digitais -->
  <div id="digitalPanel">
    <h3> Mundo Digital</h3>
    <ul id="digitalList"></ul>
  </div>

  <!-- Preview com 3 digitais -->
  <div id="digitalPreview3" aria-hidden="false" role="list"></div>

  <div id="map"></div>

  <!-- Pain√©is de filtros (forma jur√≠dica e subCategoria) -->
  <div id="filterPanel" class="filter-panel" aria-hidden="true"></div>
  <div id="filterCategories" class="filter-panel" aria-hidden="true"></div>

  <!-- Menu para escolher o tipo de filtro -->
  <div id="filterMode">
    <button class="mode-btn" data-mode="legal">Filtrar por forma jur√≠dica</button>
    <button class="mode-btn" data-mode="category">Filtrar por √°rea de atua√ß√£o</button>
  </div>

  <!-- Bot√£o para abrir op√ß√µes de filtro -->
  <button id="toggleFilterBtn" title="Mostrar Filtros">‚ò∞</button>

  <!-- SIDE PANEL -->
  <aside id="sidePanel" class="side-panel" aria-hidden="true">
    <button id="closePanel" class="panel-close" title="Fechar">‚úï</button>

    <div class="panel-header">
      <img id="panelImg" src="" alt="Imagem" />
      <div class="panel-name" id="panelName">Nome</div>
      <!-- tags AGORA em cima da forma jur√≠dica -->
      <div class="panel-subcats" id="panelSubcats"></div>
      <div class="panel-cat" id="panelCat">Categoria</div>
      <div class="media-row" id="panelMedia"></div>
    </div>

    <div class="panel-about">
      <div>
        <div class="section-about-title">Sobre</div>
        <div class="about" id="panelAbout">Proposito</div>
      </div>
    </div>

    <div class="panel-body" id="panelBody">
      <div>
        <!-- Morada -->
        <div class="section-title address-title">Morada</div>
        <div class="info-row address-row">
          <div class="info-icon">
            <img src="icons_list/iconAddress.svg" alt="Morada" class="icon-svg">
          </div>
          <div class="info-text" id="panelAddress">Endere√ßo completo</div>
        </div>

        <!-- Telefone -->
        <div class="section-title phone-title">Telefone</div>
        <div class="info-row phone-row">
          <div class="info-icon">
            <img src="icons_list/iconCall.svg" alt="Telefone" class="icon-svg">
          </div>
          <div class="info-text" id="panelPhone">+351 ...</div>
        </div>

        <!-- Email -->
        <div class="section-title email-title">Email</div>
        <div class="info-row email-row">
          <div class="info-icon">
            <img src="icons_list/iconEmail.svg" alt="Email" class="icon-svg">
          </div>
          <div class="info-text" id="panelEmail">email@exemplo.pt</div>
        </div>

        <!-- Website -->
        <div class="section-title website-title">Website</div>
        <div class="info-row website-row">
          <div class="info-icon">
            <img src="icons_list/iconWebsite.svg" alt="Website" class="icon-svg">
          </div>
          <div class="info-text" id="panelWebsite">https://...</div>
        </div>

        <!-- Atividades -->
        <div class="info-row activities-row">
          <div class="static-activities" id="panelActivities">
            Atividades: exposi√ß√µes, oficinas, congressos e eventos....
          </div>
        </div>
      </div>
    </div>
  </aside>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const toggleFilterBtn = document.getElementById('toggleFilterBtn');
    const filterPanel = document.getElementById('filterPanel');          // forma jur√≠dica
    const filterCategories = document.getElementById('filterCategories'); // subCategoria
    const filterModePanel = document.getElementById('filterMode');

    // Ao clicar no menu, fecha sempre tudo e reabre s√≥ o menu de modos
    toggleFilterBtn.addEventListener('click', () => {
      filterModePanel.classList.remove('open');
      filterPanel.classList.remove('open');
      filterCategories.classList.remove('open');

      setTimeout(() => {
        filterModePanel.classList.add('open');
      }, 10);
    });

    // Fechar menu de modos e filtros ao clicar fora
    document.addEventListener('click', (e) => {
      const clickedInsideToggle = toggleFilterBtn.contains(e.target);
      const clickedInsideMode = filterModePanel.contains(e.target);
      const clickedInsideFilterPanels =
        filterPanel.contains(e.target) || filterCategories.contains(e.target);

      if (!clickedInsideToggle && !clickedInsideMode && !clickedInsideFilterPanels) {
        filterModePanel.classList.remove('open');
        filterPanel.classList.remove('open');
        filterCategories.classList.remove('open');
      }
    });

    // A√ß√µes dos bot√µes de modo
    filterModePanel.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const mode = btn.getAttribute('data-mode');
        if (mode === 'category') {
          filterCategories.classList.add('open');
          filterPanel.classList.remove('open');
        } else if (mode === 'legal') {
          filterPanel.classList.add('open');
          filterCategories.classList.remove('open');
        }
        filterModePanel.classList.remove('open');
      });
    });

    // === CARREGAR DATA.JSON ===
    fetch('data.json').then(r => r.json()).then(data => {
      const todos = Array.isArray(data) ? data : [];

      const fisicas = todos.filter(d =>
        (d.type || '').toLowerCase() === 'fisica' &&
        d.address && d.address.latitude && d.address.longitude
      );
      const digitais = todos.filter(d => (d.type || '').toLowerCase() === 'digital');
      const pesquisaveis = [...fisicas, ...digitais];

      // === MAPA ===
      const map = L.map('map').setView([38.72, -9.18], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // === Side Panel refs ===
      const sidePanel = document.getElementById('sidePanel');
      const closePanelBtn = document.getElementById('closePanel');
      const panelImg = document.getElementById('panelImg');
      const panelName = document.getElementById('panelName');
      const panelCat = document.getElementById('panelCat');
      const panelSubcats = document.getElementById('panelSubcats');
      const panelMedia = document.getElementById('panelMedia');
      const panelAbout = document.getElementById('panelAbout');
      const panelAddress = document.getElementById('panelAddress');
      const panelPhone = document.getElementById('panelPhone');
      const panelEmail = document.getElementById('panelEmail');
      const panelWebsite = document.getElementById('panelWebsite');
      const panelActivities = document.getElementById('panelActivities');

      const addressTitle = document.querySelector('.address-title');
      const addressRow = document.querySelector('.address-row');
      const phoneTitle = document.querySelector('.phone-title');
      const phoneRow = document.querySelector('.phone-row');
      const emailTitle = document.querySelector('.email-title');
      const emailRow = document.querySelector('.email-row');
      const websiteTitle = document.querySelector('.website-title');
      const websiteRow = document.querySelector('.website-row');
      const activitiesRow = document.querySelector('.activities-row');

      // Labels bonitos para subCategorias
      const PRETTY_SUBCAT_LABEL = {
        audiovisual: 'Audiovisual',
        danca: 'Dan√ßa',
        desporto: 'Desporto',
        educacao: 'Educa√ß√£o & forma√ß√£o',
        gastronomia: 'Gastronomia',
        musica: 'M√∫sica',
        promocao_cultural: 'Promo√ß√£o cultural',
        teatro: 'Teatro'
      };

      // Mapa de forma jur√≠dica bonitinho
      const CATEGORIA_MAP = {
        'grupo': 'Grupo',
        'coletivo_cultural': 'Coletivo Cultural',
        'coletivo cultural': 'Coletivo Cultural',
        'associacao': 'Associa√ß√£o',
        'associa√ß√£o': 'Associa√ß√£o',
        'empresa_social': 'Empresa Social',
        'empresa social': 'Empresa Social',
        'outros': 'Outros',

        'centro': 'Centro',
        'coletivo': 'Coletivo',
        'companhia': 'Companhia',
        'cooperacao': 'Coopera√ß√£o',
        'coopera√ß√£o': 'Coopera√ß√£o',
        'espaco_comunitario': 'Espa√ßo comunit√°rio',
        'espaco comunitario': 'Espa√ßo comunit√°rio',
        'espa√ßo comunitario': 'Espa√ßo comunit√°rio',
        'espa√ßo comunit√°rio': 'Espa√ßo comunit√°rio',
        'frente': 'Frente',
        'grupo_teatral': 'Grupo teatral',
        'grupo teatral': 'Grupo teatral',
        'instituto': 'Instituto',
        'liga': 'Liga',
        'movimento': 'Movimento',
        'musica': 'Centro de M√∫sica',
        'm√∫sica': 'Centro de M√∫sica',
        'centro musica': 'Centro de M√∫sica',
        'centro_musica': 'Centro de M√∫sica',
        'centro musical': 'Centro musical',
        'centro cultural': 'Centro cultural',
        'rede': 'Rede',
        'uniao': 'Uni√£o',
        'uni√£o': 'Uni√£o'
      };

      // Normaliza texto da subCategoria para key compat√≠vel com ficheiros SVG
      function normalizeSubcatKey(label) {
        let t = (label || '').toString().trim().toLowerCase();
        t = t.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        t = t.replace(/&/g, 'e');
        if (t.includes('educacao')) return 'educacao';
        if (t.includes('promocao')) return 'promocao_cultural';
        t = t.replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
        return t;
      }

      const SUBCAT_ICON_MAP = {
        audiovisual: 'audiovisual.svg',
        danca: 'danca.svg',
        desporto: 'desporto.svg',
        educacao: 'educacao.svg',
        gastronomia: 'gastronomia.svg',
        musica: 'musica.svg',
        promocao_cultural: 'promocao_cultural.svg',
        teatro: 'teatro.svg'
      };

      function gerarPopupHTML(o) {
        const thumb = o.img
          ? `<img src="${o.img}" alt="${(o.nome || '')}"
               style="width:48px;height:48px;object-fit:cover;border-radius:10%;border:none;" />`
          : '';
        return `<div class="mini-popup" style="display:flex;align-items:center;gap:10px;">
          ${thumb}
          <div class="m-title" style="color:var(--accent);font-weight:700;font-size:15px;">
            ${o.nome || ''}
          </div>
        </div>`;
      }

      function openPanelFor(o) {
        if (o.img) {
          panelImg.src = o.img;
          panelImg.style.display = 'block';
        } else {
          panelImg.src = '';
          panelImg.style.display = 'none';
        }

        panelName.textContent = o.nome || '-';

        const rawCat = o.categoria || '';
        const catKey = rawCat.toLowerCase();
        panelCat.textContent = CATEGORIA_MAP[catKey] || rawCat || '-';

        // Etiquetas de subCategoria no side panel (AGORA acima da categoria)
        panelSubcats.innerHTML = '';
        let tags = [];

        if (Array.isArray(o.subcats)) {
          tags = o.subcats
            .map(k => (k || '').toString().trim())
            .filter(Boolean);
        } else if (typeof o.subCategoria === 'string') {
          tags = o.subCategoria.split(/[;,]/)
            .map(t => t.trim())
            .filter(Boolean)
            .map(t => normalizeSubcatKey(t));
        }

        const uniqueKeys = Array.from(new Set(tags));
        if (uniqueKeys.length) {
          uniqueKeys.forEach(key => {
            const label = PRETTY_SUBCAT_LABEL[key] || key;
            const span = document.createElement('span');
            span.className = 'subcat-tag';
            span.textContent = label;
            panelSubcats.appendChild(span);
          });
        }

        panelAbout.textContent =
          o.proposito || o.description || o.sobre || 'Sem descri√ß√£o dispon√≠vel.';

        // Morada
        if (o.address && (o.address.latitude && o.address.longitude)) {
          const lat = o.address.latitude;
          const lon = o.address.longitude;
          const addr = o.address.fullAddress || 'Abrir no Google Maps';
          panelAddress.innerHTML =
            `<a href="https://www.google.com/maps?q=${lat},${lon}"
               target="_blank" rel="noopener"
               style="color:var(--muted); text-decoration:none">${addr}</a>`;
          addressTitle.style.display = 'block';
          addressRow.style.display = 'flex';
        } else if (o.address && o.address.fullAddress) {
          const addr = o.address.fullAddress;
          const query = encodeURIComponent(addr);
          panelAddress.innerHTML =
            `<a href="https://www.google.com/maps/search/?api=1&query=${query}"
               target="_blank" rel="noopener"
               style="color:var(--muted); text-decoration:none">${addr}</a>`;
          addressTitle.style.display = 'block';
          addressRow.style.display = 'flex';
        } else {
          addressTitle.style.display = 'none';
          addressRow.style.display = 'none';
        }

        // Telefone
        if (o.telefone) {
          panelPhone.innerHTML =
            `<a href="tel:${o.telefone}" style="color:var(--muted); text-decoration:none">${o.telefone}</a>`;
          phoneTitle.style.display = 'block';
          phoneRow.style.display = 'flex';
        } else {
          phoneTitle.style.display = 'none';
          phoneRow.style.display = 'none';
        }

        // Email
        if (o.eMail) {
          panelEmail.innerHTML =
            `<a href="mailto:${o.eMail}" style="color:var(--muted); text-decoration:none">${o.eMail}</a>`;
          emailTitle.style.display = 'block';
          emailRow.style.display = 'flex';
        } else {
          emailTitle.style.display = 'none';
          emailRow.style.display = 'none';
        }

        // Website
        if (o.website) {
          panelWebsite.innerHTML =
            `<a href="${o.website}" target="_blank" rel="noopener"
               style="color:var(--muted); text-decoration:none">${o.website}</a>`;
          websiteTitle.style.display = 'block';
          websiteRow.style.display = 'flex';
        } else {
          websiteTitle.style.display = 'none';
          websiteRow.style.display = 'none';
        }

        // Atividades (mostra s√≥ se houver texto)
        const atividades = o.atividades || o.activities || '';
        if (atividades && atividades.trim() !== '') {
          panelActivities.textContent = atividades;
          activitiesRow.style.display = 'flex';
        } else {
          activitiesRow.style.display = 'none';
        }

        // Redes sociais
        panelMedia.innerHTML = '';
        const links = o.mediaLinks || {};
        const icons = {
          twitter: 'icons_list/Twitter.svg',
          youtube: 'icons_list/Youtube.svg',
          instagram: 'icons_list/Instagram.svg',
          linkedin: 'icons_list/Linkedin.svg',
          thread: 'icons_list/Thread.svg',
          facebook: 'icons_list/Facebook.svg',
          tiktok: 'icons_list/Tiktok.svg'
        };

        Object.entries(links).forEach(([key, url]) => {
          if (url) {
            const a = document.createElement('a');
            a.href = url;
            a.target = '_blank';
            a.rel = 'noopener';
            const img = document.createElement('img');
            img.src = icons[key];
            img.alt = key;
            img.style.width = '24px';
            img.style.height = '24px';
            img.style.objectFit = 'contain';
            a.appendChild(img);
            panelMedia.appendChild(a);
          }
        });

        sidePanel.classList.add('open');
        sidePanel.setAttribute('aria-hidden', 'false');
      }

      function closePanel() {
        sidePanel.classList.remove('open');
        sidePanel.setAttribute('aria-hidden', 'true');
      }
      closePanelBtn.addEventListener('click', closePanel);

      // === MARCADORES NO MAPA ===
      const categorias = {};
      fisicas.forEach(o => {
        const cat = o.categoria || 'Outros';
        if (!categorias[cat]) categorias[cat] = [];
        categorias[cat].push(o);
      });

      const markers = [];
      const subcatLabelsByKey = {};

      // Constru√ß√£o de markers + subCategorias
      Object.entries(categorias).forEach(([cat, orgs]) => {
        orgs.forEach(o => {
          const lat = parseFloat(o.address.latitude);
          const lon = parseFloat(o.address.longitude);
          if (isNaN(lat) || isNaN(lon)) return;

          const subCats = [];

          // Formato array de slugs
          if (Array.isArray(o.subcats)) {
            o.subcats.forEach(kRaw => {
              const key = (kRaw || '').toString().trim();
              if (!key) return;
              subCats.push(key);
              if (!subcatLabelsByKey[key]) {
                subcatLabelsByKey[key] = PRETTY_SUBCAT_LABEL[key] || key;
              }
            });
          }

          // Formato texto "M√∫sica; Teatro; ..."
          if (o.subCategoria) {
            o.subCategoria.split(/[;,]/).forEach(raw => {
              const label = raw.trim();
              if (!label) return;
              const key = normalizeSubcatKey(label);
              subCats.push(key);
              if (!subcatLabelsByKey[key]) {
                subcatLabelsByKey[key] =
                  PRETTY_SUBCAT_LABEL[key] || label;
              }
            });
          }

          const marker = L.marker([lat, lon], {
            icon: L.icon({
              iconUrl: `icons/${cat}.svg`,
              iconSize: [44, 44],
              iconAnchor: [22, 22],
              popupAnchor: [0, -22]
            })
          });

          marker.bindPopup(gerarPopupHTML(o), { closeButton: false, offset: [0, -8] });

          marker.on('click', () => {
            marker.openPopup();
            openPanelFor(o);
            map.panTo([lat, lon], { animate: true });
          });

          marker.addTo(map);

          markers.push({
            marker,
            orgData: o,
            mainCat: cat,
            subCats
          });
        });
      });

      // === Estado dos filtros ===
      const allCategoryNames = Object.keys(categorias);
      const activeCategories = new Set(allCategoryNames);

      const allSubcatKeys = Object.keys(subcatLabelsByKey);
      const activeSubcats = new Set(allSubcatKeys);

      function recomputeVisibility() {
        markers.forEach(({ marker, mainCat, subCats }) => {
          const catOk = activeCategories.has(mainCat);
          const subOk = (activeSubcats.size === 0)
            ? true
            : subCats.some(sc => activeSubcats.has(sc));
          const visible = catOk && subOk;

          if (marker._icon) {
            marker._icon.style.display = visible ? '' : 'none';
          }
          if (marker._shadow) {
            marker._shadow.style.display = visible ? '' : 'none';
          }
        });
      }

      // === FILTROS por forma jur√≠dica (filterPanel) ===
      const filterPanelElem = document.getElementById('filterPanel');

      allCategoryNames.forEach(cat => {
        const btn = document.createElement('div');
        btn.className = 'filter-item active';

        const iconUrl = `icons_filter/${cat}.svg`;
        const iconImg = document.createElement('img');
        iconImg.src = iconUrl;
        iconImg.alt = cat;
        iconImg.style.width = '60px';
        iconImg.style.height = '60px';
        iconImg.style.objectFit = 'contain';
        btn.appendChild(iconImg);

        const categoryNameSpan = document.createElement('span');
        categoryNameSpan.textContent = cat;
        categoryNameSpan.style.display = 'none';
        btn.appendChild(categoryNameSpan);

        btn.addEventListener('click', () => {
          if (activeCategories.has(cat)) {
            activeCategories.delete(cat);
            btn.classList.remove('active');
          } else {
            activeCategories.add(cat);
            btn.classList.add('active');
          }
          recomputeVisibility();
        });

        filterPanelElem.appendChild(btn);
      });

      const controlsDiv = document.createElement('div');
      controlsDiv.className = 'filter-controls';
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'toggle-all';
      toggleBtn.textContent = 'Ocultar';
      let allVisible = true;

      toggleBtn.addEventListener('click', () => {
        allVisible = !allVisible;
        toggleBtn.textContent = allVisible ? 'Ocultar' : 'Mostrar';

        activeCategories.clear();
        if (allVisible) {
          allCategoryNames.forEach(c => activeCategories.add(c));
        }

        Array.from(filterPanelElem.children).forEach(child => {
          if (!child.classList.contains('filter-controls')) {
            if (allVisible) child.classList.add('active');
            else child.classList.remove('active');
          }
        });

        recomputeVisibility();
      });

      controlsDiv.appendChild(toggleBtn);
      filterPanelElem.appendChild(controlsDiv);

      // === FILTROS por subCategoria (filterCategories) ===
      const filterCategoriesElem = document.getElementById('filterCategories');

      allSubcatKeys.forEach(key => {
        const label = subcatLabelsByKey[key];
        const btn = document.createElement('div');
        btn.className = 'filter-item active';

        const iconName = SUBCAT_ICON_MAP[key] || 'audiovisual.svg';
        const iconImg = document.createElement('img');
        iconImg.src = `icons_categories/${iconName}`;
        iconImg.alt = label;
        iconImg.style.width = '60px';
        iconImg.style.height = '60px';
        iconImg.style.objectFit = 'contain';
        btn.appendChild(iconImg);

        const labelSpan = document.createElement('span');
        labelSpan.textContent = label;
        labelSpan.style.display = 'none';
        btn.appendChild(labelSpan);

        btn.addEventListener('click', () => {
          if (activeSubcats.has(key)) {
            activeSubcats.delete(key);
            btn.classList.remove('active');
          } else {
            activeSubcats.add(key);
            btn.classList.add('active');
          }
          recomputeVisibility();
        });

        filterCategoriesElem.appendChild(btn);
      });

      const controlsDivSub = document.createElement('div');
      controlsDivSub.className = 'filter-controls';
      const toggleBtnSub = document.createElement('button');
      toggleBtnSub.className = 'toggle-all';
      toggleBtnSub.textContent = 'Ocultar';
      let allSubVisible = true;

      toggleBtnSub.addEventListener('click', () => {
        allSubVisible = !allSubVisible;
        toggleBtnSub.textContent = allSubVisible ? 'Ocultar' : 'Mostrar';

        activeSubcats.clear();
        if (allSubVisible) {
          allSubcatKeys.forEach(k => activeSubcats.add(k));
        }

        Array.from(filterCategoriesElem.children).forEach(child => {
          if (!child.classList.contains('filter-controls')) {
            if (allSubVisible) child.classList.add('active');
            else child.classList.remove('active');
          }
        });

        recomputeVisibility();
      });

      controlsDivSub.appendChild(toggleBtnSub);
      filterCategoriesElem.appendChild(controlsDivSub);

      // ============================================================
      // === L√ìGICA DIGITAL BTN + LISTA + PREVIEW 3 ALEAT√ìRIOS ======
      // ============================================================
      const digitalBtn = document.getElementById('digitalBtn');
      const digitalPanel = document.getElementById('digitalPanel');
      const digitalList = document.getElementById('digitalList');

      digitalBtn.addEventListener('click', () => {
        digitalPanel.classList.toggle('open');
      });

      function preencherDigitais() {
        digitalList.innerHTML = '';

        if (!digitais.length) {
          digitalList.innerHTML = `<li>Nenhuma organiza√ß√£o digital encontrada.</li>`;
          return;
        }

        digitais.forEach(o => {
          const li = document.createElement('li');
          // >>> AQUI: removi a linha com categoria
          li.innerHTML = `
            <img src="${o.img || 'https://via.placeholder.com/44'}" alt="">
            <div>
              <div style="font-weight:700;color:var(--accent)">${o.nome}</div>
            </div>
          `;

          li.addEventListener('click', () => {
            digitalPanel.classList.remove('open');
            openPanelFor(o);
          });

          digitalList.appendChild(li);
        });
      }

      preencherDigitais();

      // Preview 3 digitais
      (function () {
        const previewEl = document.getElementById('digitalPreview3');
        if (!previewEl) return;

        function pickRandom(arr, n) {
          const copy = Array.isArray(arr) ? [...arr] : [];
          const out = [];
          while (out.length < n && copy.length) {
            const i = Math.floor(Math.random() * copy.length);
            out.push(copy.splice(i, 1)[0]);
          }
          return out;
        }

        function render3Preview() {
          previewEl.innerHTML = '';

          if (!digitais || !digitais.length) {
            previewEl.style.display = 'none';
            return;
          }

          const picks = pickRandom(digitais, 4);
          picks.forEach(o => {
            const tile = document.createElement('div');
            tile.className = 'digital3-tile';
            tile.title = o.nome || 'Sem nome';
            tile.innerHTML = `
              <img src="${o.img || 'https://via.placeholder.com/56'}" alt="${(o.nome || '')}" />
              <div class="d3-name">${o.nome || 'Sem nome'}</div>
            `;

            tile.addEventListener('click', (ev) => {
              ev.stopPropagation();
              try { openPanelFor(o); } catch (err) { console.error(err); }
              if (o.address && o.address.latitude && o.address.longitude && typeof map !== 'undefined') {
                const lat = parseFloat(o.address.latitude);
                const lon = parseFloat(o.address.longitude);
                if (!isNaN(lat) && !isNaN(lon)) map.setView([lat, lon], 14);
              }
            });

            previewEl.appendChild(tile);
          });

          previewEl.style.display = 'flex';
        }

        render3Preview();

        const digitalBtnEl = document.getElementById('digitalBtn');
        if (digitalBtnEl) {
          digitalBtnEl.addEventListener('click', () => {
            setTimeout(render3Preview, 120);
          });
        }
      })();

      // === L√≥gica de pesquisa ===
      const searchInput = document.getElementById('searchInput');
      const searchResults = document.getElementById('searchResults');

      function normalizeText(t) {
        return (t || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
      }

      function renderSearchResults(items) {
        if (!items || !items.length) {
          searchResults.innerHTML = '<li>Nenhum resultado</li>';
          searchResults.style.display = 'block';
          return;
        }
        searchResults.innerHTML = '';
        items.slice(0, 20).forEach(o => {
          const li = document.createElement('li');
          // >>> AQUI: removi o bloco .m-cat
          li.innerHTML = `
            <div class="result-item">
              <img src="${o.img || 'https://via.placeholder.com/40'}" alt="">
              <div>
                <div class="m-title">${o.nome || 'Sem nome'}</div>
              </div>
            </div>
          `;
          li.addEventListener('click', () => {
            searchResults.style.display = 'none';
            if (o.address && o.address.latitude && o.address.longitude) {
              const lat = parseFloat(o.address.latitude);
              const lon = parseFloat(o.address.longitude);
              if (!isNaN(lat) && !isNaN(lon)) {
                map.setView([lat, lon], 15, { animate: true });
              }
            }
            openPanelFor(o);
          });
          searchResults.appendChild(li);
        });
        searchResults.style.display = 'block';
      }

      function filterSearch(q) {
        const nq = normalizeText(q);
        if (!nq) {
          searchResults.style.display = 'none';
          return;
        }
        const results = pesquisaveis.filter(o => {
          const hay = [
            o.nome,
            o.categoria,
            o.subCategoria,
            o.proposito,
            o.description,
            o.sobre,
            o.address && o.address.fullAddress,
            o.eMail,
            o.website
          ].join(' ');
          return normalizeText(hay).includes(nq);
        });
        renderSearchResults(results);
      }

      let searchTimeout = null;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const q = e.target.value;
        searchTimeout = setTimeout(() => filterSearch(q), 180);
      });

      document.addEventListener('click', (ev) => {
        if (!document.querySelector('.search-box').contains(ev.target)) {
          searchResults.style.display = 'none';
        }
      });

      searchInput.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') {
          searchResults.style.display = 'none';
          searchInput.blur();
        } else if (ev.key === 'Enter') {
          const first = searchResults.querySelector('li');
          if (first) first.click();
        }
      });

      searchResults.style.zIndex = 1600;
      searchResults.style.maxHeight = '360px';
      searchResults.style.overflowY = 'auto';

    }).catch(err => {
      console.error('Erro a carregar data.json', err);
      alert('Erro a carregar data.json ‚Äî ver console.');
    });
  </script>

</body>

</html>
